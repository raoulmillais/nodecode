<!DOCTYPE html>

<html>

<head>
    <title>Raoul Millais - HTML Node Garden</title>
    <!--[if IE]>
    <script type="text/javascript>
        window.location = 'http://upgradeyourbrowser.org/';
    </script>
    <![endif]-->
    
    <script type="text/javascript" src="js/lib/processing-0.9.1.min.js"></script>
    <script type="text/javascript" src="js/lib/jquery-1.4.2.min.js"></script>
    
    
    <link href="css/main.css" rel="stylesheet" media="all" type="text/css" />
</head>

<body>
    <header class="site">
        <hgroup>
            <h1>raoulmillais.com</h1>
            <h2>HTML5 and processing.js Node Garden</h2>
        </hgroup>
    </header>

    <canvas id="canvas">
        Your browser does not support the &lt;canvas/&gt; element.
        Please upgrade your browser to view this demo.
    </canvas>
    
    <canvas id="canvas-noprocessing">
        Your browser does not support the &lt;canvas/&gt; element.
        Please upgrade your browser to view this demo.
    </canvas>

    <div id="node-control">
        <h2>Control Nodes</h2>
        <form>
            <div id="control-node-colour-section">
                <span id="control-node-colour-label">Select Colour:</span>
                <ul id="control-node-colour">
                    <li id="control-node-colour-cyan">&nbsp;</li>
                    <li id="control-node-colour-orange">&nbsp;</li>
                    <li id="control-node-colour-purple">&nbsp;</li>
                    <li id="control-node-colour-lime" class="selected">&nbsp;</li>
                </ul>
            </div>
            <p>
                <label for="control-node-count">Nodes (Currently <span id="current-node-count">35</span>):</label>
                <input type="text" name="control-node-count" id="control-node-count" value="5" />
                <input type="button" id="add-nodes" value="Add" class="update" />
                <input type="button" id="remove-nodes" value="Remove" class="update" />
            </p>
        </form>
    </div>
    
<script id="node-code" type="application/processing">
var initialNodeCount = 35;
var maxNodeCount = 70;
var minNodeCount = 2;
var nodeGardenSize = 400;
var globalMaxSize = 15; // TODO: Account for clicking adding to size

var fps = 20;
var nodes = [];

var nodeRedValue = 201;
var nodeGreenValue = 255;
var nodeBlueValue = 32;

var nodeClickErrorAllowance = 10;
var nodeClickGrowthRate = 6;

void setup() {
    size(nodeGardenSize, nodeGardenSize);
    background(25, 25, 26);
    frameRate(fps);
    for (var i = 0; i < initialNodeCount; i++) {
        nodes[i] = new Node(random(1, nodeGardenSize), random(1, nodeGardenSize), 1, random(2, globalMaxSize));
        nodes[i].red = nodeRedValue;
        nodes[i].blue = nodeBlueValue;
        nodes[i].green = nodeGreenValue;
    }
}

void mousePressed() {
    var nodeClicked = false;
    for (int i = 0; i < nodes.length; i++) {
        var radius =(nodes[i].size + nodeClickErrorAllowance) / 2;
        if (nodes[i].x - radius <= mouseX && nodes[i].x + radius >= mouseX
            && nodes[i].y - radius <= mouseY && nodes[i].y + radius >= mouseY) {
            nodesClicked = true;
            nodes[i].grow();
        }
    }
    if (nodeClicked === false) {
        for (int i = 0; i < nodes.length; i++) {
            nodes[i].calculateVelocity();
        }
    }
}

void draw() {
    smooth();
    for (var  i = 0; i < nodes.length; i++) {
        nodes[i].move();
    }
    background(25, 25, 26);
    for (int i = 0; i < nodes.length - 1; i++) {
        for (int j = i + 1; j < nodes.length; j++) {
            float distance = distanceBetweenNodes(nodes[i], nodes[j]);
            if (distance < 120) {
                strokeWeight(Node.STROKE_WEIGHT);
                float alphaValue = 100 - distance / 120 * 100;
                fill(nodes[i].red, nodes[i].green, nodes[i].blue, alphaValue);
                ellipse(nodes[i].x, nodes[i].y, nodes[i].size, nodes[i].size);
                
                strokeWeight(Node.STROKE_WEIGHT);
                stroke(nodes[i].red, nodes[i].green, nodes[i].blue, alphaValue);
                line(nodes[i].x, nodes[i].y, nodes[j].x, nodes[j].y);
            }
        }
    }
}

float distanceBetweenNodes(Node n1, Node n2) {
        int a = n2.y - n1.y;
        int b = n2.x - n1.x;
        return sqrt(sq(a) + sq(b));
}
    
class Node {
    float velocityx, velocityy;
    int x, y, size;
    int red, green, blue;
    final static int STROKE_WEIGHT = 3;
    
    Node(int xpos, int ypos, int zpos, int nodeSize) {
        x = xpos;
        y = ypos;
        z = zpos;
        size = nodeSize;
        calculateVelocity();
    }
    
    void grow() {
        var currentSize = size;
        size = currentSize + nodeClickGrowthRate;
        // TODO: log node id and size then check new maxPossible node size
        // TODO: adjust velocity after size adjustment
    }
    
    void move() {
        x += velocityx;
        y += velocityy;
        if (x > nodeGardenSize - getRadius()) {
            x = nodeGardenSize - getRadius();
            velocityx *= -1;
        }
        if(x < getRadius()) {
            x = getRadius();
            velocityx *= -1;
        }
        if (y > nodeGardenSize - getRadius()) {
            y = nodeGardenSize - getRadius();
            velocityy *= -1;
        }        
        if (y < getRadius()) {
            y = getRadius();
            velocityy *= -1;
        }
    }
    
    int getRadius() {
        return (size / 2 + Node.STROKE_WEIGHT /2);
    }
    
    void calculateVelocity() {
        int maxVelocity = globalMaxSize - size;
        int minVelocity = -(maxVelocity / 2);
        velocityx = random(-5, maxVelocity);
        velocityy = random(-5, maxVelocity);
    }
}

$('#add-nodes').click(function(event) {
    if (nodes.length >= maxNodeCount) return;
    var newNodeCount = parseInt($('#control-node-count').val());
    for(var i = 0; i < newNodeCount; i++) {
        var newNode = new Node(random(1, nodeGardenSize), random(1, nodeGardenSize), 1, random(2, globalMaxSize))
        nodes.push(newNode);
        newNode.red = nodeRedValue;
        newNode.blue = nodeBlueValue;
        newNode.green = nodeGreenValue;
    }
    $('#current-node-count').text(nodes.length);
});

$('#remove-nodes').click(function(event) {
   if (nodes.length <= minNodeCount) return;
    var newNodeCount = parseInt($('#control-node-count').val());
    for(var i = 0; i < newNodeCount; i++) {
        if (nodes.length > minNodeCount) {
            nodes.pop();
        }
    }
    $('#current-node-count').text(nodes.length);
});

$('#control-node-colour li').click(function() {
    $('#control-node-colour li').removeClass('selected');
    $(this).toggleClass('selected');
    
    switch (this.id) {
        case 'control-node-colour-cyan':
            nodeRedValue = 25;
            nodeGreenValue = 240;
            nodeBlueValue = 252;
            break;
        case 'control-node-colour-lime':
            nodeRedValue = 201;
            nodeGreenValue = 255;
            nodeBlueValue = 32;
            break;
        case 'control-node-colour-orange':
            nodeRedValue = 252;
            nodeGreenValue = 90;
            nodeBlueValue = 0;
            break;
        case 'control-node-colour-purple':
            nodeRedValue = 243;
            nodeGreenValue = 0;
            nodeBlueValue = 252;
            break;
    }
});

</script>
<script type="text/javascript">
(function() {
    var init = function() {
        var canvas = document.getElementById("canvas");
        var code = document.getElementById("node-code").text;
        Processing(canvas,code);
    }
    addEventListener("DOMContentLoaded", init, false);
})();
</script>

</body>

</html>
